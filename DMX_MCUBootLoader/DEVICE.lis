                        .module DEVICE.C
                        .area text(rom, con, rel)
 0000                   .dbfile DEVICE.C
                        .area data(ram, con, rel)
 0000                   .dbfile DEVICE.C
 0000           _EP2SendBusy::
 0000                   .blkb 1
                        .area idata
 0000 00                .byte 0
                        .area data(ram, con, rel)
 0001                   .dbfile DEVICE.C
 0001                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0001                   .dbsym e EP2SendBusy _EP2SendBusy c
 0001           _MyDevDescr::
 0001                   .blkb 2
                        .area idata
 0001 1201              .byte 18,1
                        .area data(ram, con, rel)
 0003                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0003                   .blkb 2
                        .area idata
 0003 1001              .byte 16,1
                        .area data(ram, con, rel)
 0005                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0005                   .blkb 2
                        .area idata
 0005 FF80              .byte 255,128
                        .area data(ram, con, rel)
 0007                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0007                   .blkb 2
                        .area idata
 0007 3708              .byte 55,8
                        .area data(ram, con, rel)
 0009                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0009                   .blkb 2
                        .area idata
 0009 1538              .byte 21,56
                        .area data(ram, con, rel)
 000B                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 000B                   .blkb 2
                        .area idata
 000B 0128              .byte 1,40
                        .area data(ram, con, rel)
 000D                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 000D                   .blkb 2
                        .area idata
 000D 0001              .byte 0,1
                        .area data(ram, con, rel)
 000F                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 000F                   .blkb 2
                        .area idata
 000F 0102              .byte 1,2
                        .area data(ram, con, rel)
 0011                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0011                   .blkb 2
                        .area idata
 0011 0001              .byte 0,1
                        .area data(ram, con, rel)
 0013                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0013                   .dbsym e MyDevDescr _MyDevDescr A[18:18]c
 0013           _MyCfgDescr::
 0013                   .blkb 2
                        .area idata
 0013 0902              .byte 9,2
                        .area data(ram, con, rel)
 0015                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0015                   .blkb 2
                        .area idata
 0015 2700              .byte 39,0
                        .area data(ram, con, rel)
 0017                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0017                   .blkb 2
                        .area idata
 0017 0101              .byte 1,1
                        .area data(ram, con, rel)
 0019                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0019                   .blkb 2
                        .area idata
 0019 0080              .byte 0,128
                        .area data(ram, con, rel)
 001B                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 001B                   .blkb 2
                        .area idata
 001B 3209              .byte 50,9
                        .area data(ram, con, rel)
 001D                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 001D                   .blkb 2
                        .area idata
 001D 0400              .byte 4,0
                        .area data(ram, con, rel)
 001F                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 001F                   .blkb 2
                        .area idata
 001F 0003              .byte 0,3
                        .area data(ram, con, rel)
 0021                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0021                   .blkb 2
                        .area idata
 0021 FF80              .byte 255,128
                        .area data(ram, con, rel)
 0023                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0023                   .blkb 2
                        .area idata
 0023 3700              .byte 55,0
                        .area data(ram, con, rel)
 0025                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0025                   .blkb 2
                        .area idata
 0025 0705              .byte 7,5
                        .area data(ram, con, rel)
 0027                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0027                   .blkb 2
                        .area idata
 0027 8202              .byte 130,2
                        .area data(ram, con, rel)
 0029                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0029                   .blkb 2
                        .area idata
 0029 4000              .byte 64,0
                        .area data(ram, con, rel)
 002B                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 002B                   .blkb 2
                        .area idata
 002B 0007              .byte 0,7
                        .area data(ram, con, rel)
 002D                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 002D                   .blkb 2
                        .area idata
 002D 0502              .byte 5,2
                        .area data(ram, con, rel)
 002F                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 002F                   .blkb 2
                        .area idata
 002F 0240              .byte 2,64
                        .area data(ram, con, rel)
 0031                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0031                   .blkb 2
                        .area idata
 0031 0000              .byte 0,0
                        .area data(ram, con, rel)
 0033                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0033                   .blkb 2
                        .area idata
 0033 0705              .byte 7,5
                        .area data(ram, con, rel)
 0035                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0035                   .blkb 2
                        .area idata
 0035 8103              .byte 129,3
                        .area data(ram, con, rel)
 0037                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0037                   .blkb 2
                        .area idata
 0037 0800              .byte 8,0
                        .area data(ram, con, rel)
 0039                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0039                   .blkb 1
                        .area idata
 0039 00                .byte 0
                        .area data(ram, con, rel)
 003A                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 003A                   .dbsym e MyCfgDescr _MyCfgDescr A[39:39]c
 003A           _MyLangDescr::
 003A                   .blkb 2
                        .area idata
 003A 0403              .byte 4,3
                        .area data(ram, con, rel)
 003C                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 003C                   .blkb 2
                        .area idata
 003C 0904              .byte 9,4
                        .area data(ram, con, rel)
 003E                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 003E                   .dbsym e MyLangDescr _MyLangDescr A[4:4]c
 003E           _MyManuInfo::
 003E                   .blkb 2
                        .area idata
 003E 0E03              .byte 14,3
                        .area data(ram, con, rel)
 0040                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0040                   .blkb 2
                        .area idata
 0040 4700              .byte 'G,0
                        .area data(ram, con, rel)
 0042                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0042                   .blkb 2
                        .area idata
 0042 5A00              .byte 'Z,0
                        .area data(ram, con, rel)
 0044                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0044                   .blkb 2
                        .area idata
 0044 5400              .byte 'T,0
                        .area data(ram, con, rel)
 0046                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0046                   .blkb 2
                        .area idata
 0046 5300              .byte 'S,0
                        .area data(ram, con, rel)
 0048                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0048                   .blkb 2
                        .area idata
 0048 4E00              .byte 'N,0
                        .area data(ram, con, rel)
 004A                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 004A                   .blkb 2
                        .area idata
 004A 5900              .byte 'Y,0
                        .area data(ram, con, rel)
 004C                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 004C                   .dbsym e MyManuInfo _MyManuInfo A[14:14]c
 004C           _MyProdInfo::
 004C                   .blkb 2
                        .area idata
 004C 1203              .byte 18,3
                        .area data(ram, con, rel)
 004E                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 004E                   .blkb 2
                        .area idata
 004E 5400              .byte 'T,0
                        .area data(ram, con, rel)
 0050                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0050                   .blkb 2
                        .area idata
 0050 5300              .byte 'S,0
                        .area data(ram, con, rel)
 0052                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0052                   .blkb 2
                        .area idata
 0052 4E00              .byte 'N,0
                        .area data(ram, con, rel)
 0054                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0054                   .blkb 2
                        .area idata
 0054 5900              .byte 'Y,0
                        .area data(ram, con, rel)
 0056                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0056                   .blkb 2
                        .area idata
 0056 2D00              .byte 45,0
                        .area data(ram, con, rel)
 0058                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0058                   .blkb 2
                        .area idata
 0058 3100              .byte 49,0
                        .area data(ram, con, rel)
 005A                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 005A                   .blkb 2
                        .area idata
 005A 2E00              .byte 46,0
                        .area data(ram, con, rel)
 005C                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 005C                   .blkb 2
                        .area idata
 005C 3000              .byte 48,0
                        .area data(ram, con, rel)
 005E                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 005E                   .dbsym e MyProdInfo _MyProdInfo A[18:18]c
 005E           _UsbConfig::
 005E                   .blkb 1
                        .area idata
 005E 00                .byte 0
                        .area data(ram, con, rel)
 005F                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 005F                   .dbsym e UsbConfig _UsbConfig c
 005F           _UsbReset::
 005F                   .blkb 1
                        .area idata
 005F 00                .byte 0
                        .area data(ram, con, rel)
 0060                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0060                   .dbsym e UsbReset _UsbReset c
                        .area vector(rom, abs)
                        .org 28
 001C 0C940000          jmp _int6_isr
                        .area data(ram, con, rel)
 0060                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
                        .area bss(ram, con, rel)
 0000                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0000           L2:
 0000                   .blkb 1
 0001           L3:
 0001                   .blkb 1
 0002           L4:
 0002                   .blkb 2
                        .area text(rom, con, rel)
 0000                   .dbfile D:\OneDrive\Work\chen\FirmWare_CT\DMX_MCUBootLoader\DEVICE.C
 0000                   .dbfunc e int6_isr _int6_isr fV
 0000                   .dbstruct 0 8 _USB_SETUP_REQ
 0000                   .dbfield 0 bType c
 0000                   .dbfield 1 bReq c
 0000                   .dbfield 2 wValueL c
 0000                   .dbfield 3 wValueH c
 0000                   .dbfield 4 wIndexL c
 0000                   .dbfield 5 wIndexH c
 0000                   .dbfield 6 wLengthL c
 0000                   .dbfield 7 wLengthH c
 0000                   .dbend
 0000                   .dbsym s pDescr L4 pc
 0000                   .dbsym s SetupLen L3 c
 0000                   .dbsym s SetupReq L2 c
 0000           ;    SetupReqBuf -> y+2
 0000           ;              i -> <dead>
 0000           ;              k -> <dead>
 0000           ;              l -> R10
 0000           ;              m -> R10
 0000           ;              s -> R20
                        .even
 0000           _int6_isr::
 0000 0A92              st -y,R0
 0002 1A92              st -y,R1
 0004 2A92              st -y,R2
 0006 3A92              st -y,R3
 0008 4A92              st -y,R4
 000A 5A92              st -y,R5
 000C 6A92              st -y,R6
 000E 7A92              st -y,R7
 0010 8A92              st -y,R8
 0012 9A92              st -y,R9
 0014 0A93              st -y,R16
 0016 1A93              st -y,R17
 0018 2A93              st -y,R18
 001A 3A93              st -y,R19
 001C 8A93              st -y,R24
 001E 9A93              st -y,R25
 0020 AA93              st -y,R26
 0022 BA93              st -y,R27
 0024 EA93              st -y,R30
 0026 FA93              st -y,R31
 0028 0FB6              IN R0,63
 002A 0A92              st -y,R0
 002C 0E940000          xcall push_xgsetF00C
 0030 2A97              sbiw R28,10
 0032                   .dbline -1
 0032                   .dbline 45
 0032           ; /* CH374芯片 应用层 V1.0 */
 0032           ; /* USB设备,模拟CH372或CH375的TEST程序与计算机通讯 */
 0032           ; 
 0032           ; #include      "HAL.H"                 // 其它单片机需修改HAL*硬件抽象层的几个文件
 0032           ;  
 0032           ; typedef struct RX
 0032           ; {
 0032           ;  unsigned char flag;
 0032           ;  unsigned char len;
 0032           ;  unsigned char buf[64];
 0032           ; };
 0032           ; extern struct RX RxData;
 0032           ; 
 0032           ; unsigned char EP2SendBusy=0;
 0032           ; 
 0032           ; // 设备描述符
 0032           ; const UINT8C  MyDevDescr[] = {0x12, 0x01, 0x10, 0x01,
 0032           ;                                                               0xFF, 0x80, 0x37, 0x08,
 0032           ;                                                               0x15, 0x38, 0x01, 0x28,  // 厂商ID和产品ID
 0032           ;                                                               0x00, 0x01, 0x01, 0x02,
 0032           ;                                                               0x00,  0x01 };
 0032           ; // 配置描述符
 0032           ; const UINT8C  MyCfgDescr[] = { 0x09, 0x02, 0x27, 0x00, 0x01, 0x01, 0x00, 0x80, 0x32,
 0032           ;                                                                0x09, 0x04, 0x00, 0x00, 0x03, 0xFF, 0x80, 0x37, 0x00,
 0032           ;                                                                0x07, 0x05, 0x82, 0x02, 0x40, 0x00, 0x00,
 0032           ;                                                                0x07, 0x05, 0x02, 0x02, 0x40, 0x00, 0x00,
 0032           ;                                                                0x07, 0x05, 0x81, 0x03, 0x08, 0x00, 0x00 };
 0032           ; // 语言描述符
 0032           ; const UINT8C  MyLangDescr[] = { 0x04, 0x03, 0x09, 0x04 };
 0032           ; 
 0032           ; // 厂家信息
 0032           ; const UINT8C  MyManuInfo[] = { 0x0E, 0x03, 'G', 0, 'Z', 0, 'T', 0, 'S', 0, 'N', 0, 'Y', 0 };
 0032           ; // 产品信息
 0032           ; //const       UINT8C  MyProdInfo[] = { 0x16, 0x03, 'S', 0, 'H', 0, 'Y', 0, '-', 0, '1', 0 , ' ', 0, 'V', 0 , '1', 0 , '.', 0 , '0', 0 };
 0032           ; const UINT8C  MyProdInfo[] = { 0x12, 0x03, 'T', 0, 'S', 0, 'N', 0, 'Y', 0, '-', 0 , '1', 0 , '.', 0 , '0', 0  };
 0032           ; 
 0032           ; void  USB_DeviceInterrupt( void );  // USB设备中断服务程序
 0032           ; void  Init374Device( void );  // 初始化USB设备
 0032           ; void USBStart(void);
 0032           ; unsigned char UsbConfig = 0,UsbReset = 0;     // USB配置标志
 0032           ; 
 0032           ; 
 0032           ; #pragma interrupt_handler int6_isr:iv_INT6
 0032           ; void int6_isr(void)
 0032           ; {
 0032                   .dbline 47
 0032           ;     unsigned int k;
 0032           ;       UINT8   s,l,i,m=0;
 0032 AA24              clr R10
 0034                   .dbline 51
 0034           ;       static  UINT8   SetupReq, SetupLen;
 0034           ;       static  PUINT8  pDescr;
 0034           ;       
 0034           ;       s = Read374Byte( REG_INTER_FLAG );  // 获取中断状态
 0034 09E0              ldi R16,9
 0036 0E940000          xcall _Read374Byte
 003A 402F              mov R20,R16
 003C                   .dbline 53
 003C           ; 
 003C           ;     if(!(s & BIT_IF_INTER_FLAG))  //0x0f
 003C 842F              mov R24,R20
 003E 8F70              andi R24,15
 0040 09F4              brne L5
 0042           X0:
 0042                   .dbline 54
 0042           ;           return;         
 0042 67C2              xjmp L1
 0044           L5:
 0044                   .dbline 56
 0044           ;       
 0044           ;       if ( s & BIT_IF_BUS_RESET )    //0x02
 0044 41FF              sbrs R20,1
 0046 18C0              rjmp L7
 0048           X1:
 0048                   .dbline 57
 0048           ;       {  // USB总线复位
 0048                   .dbline 58
 0048           ;           UsbReset = 1;
 0048 81E0              ldi R24,1
 004A 80935F00          sts _UsbReset,R24
 004E                   .dbline 59
 004E           ;               Write374Byte( REG_USB_ADDR, 0x00 );  // 清USB设备地址
 004E 2227              clr R18
 0050 08E0              ldi R16,8
 0052 0E940000          xcall _Write374Byte
 0056                   .dbline 60
 0056           ;               Write374Byte( REG_USB_ENDP0, M_SET_EP0_TRAN_NAK( 0 ) );
 0056 2EE0              ldi R18,14
 0058 0CE0              ldi R16,12
 005A 0E940000          xcall _Write374Byte
 005E                   .dbline 61
 005E           ;               Write374Byte( REG_USB_ENDP1, M_SET_EP1_TRAN_NAK( 0 ) );
 005E 2EE0              ldi R18,14
 0060 0DE0              ldi R16,13
 0062 0E940000          xcall _Write374Byte
 0066                   .dbline 62
 0066           ;               Write374Byte( REG_USB_ENDP2, M_SET_EP2_TRAN_NAK( 0 ) );
 0066 22E0              ldi R18,2
 0068 0EE0              ldi R16,14
 006A 0E940000          xcall _Write374Byte
 006E                   .dbline 63
 006E           ;               Write374Byte( REG_INTER_FLAG, BIT_IF_USB_PAUSE | BIT_IF_BUS_RESET );  // 清中断标志
 006E 22E1              ldi R18,18
 0070 09E0              ldi R16,9
 0072 0E940000          xcall _Write374Byte
 0076                   .dbline 64
 0076           ;       }
 0076 4DC2              xjmp L8
 0078           L7:
 0078                   .dbline 65
 0078           ;       else if ( s & BIT_IF_TRANSFER )  //0x01
 0078 40FF              sbrs R20,0
 007A 30C2              rjmp L9
 007C           X2:
 007C                   .dbline 66
 007C           ;       {  // USB传输
 007C                   .dbline 67
 007C           ;               s = Read374Byte( REG_USB_STATUS );  //USB状态, 只读  REG_USB_STATUS=0x0a
 007C 0AE0              ldi R16,10
 007E 0E940000          xcall _Read374Byte
 0082 402F              mov R20,R16
 0084                   .dbline 69
 0084           ;                //printf("BIT_IF_TRANSFER s=%x\r\n",s);
 0084           ;               switch( s & BIT_STAT_PID_ENDP )   //USB传输的事务和端点号：BIT_STAT_PID_ENDP=0x0f
 0084 642F              mov R22,R20
 0086 7727              clr R23
 0088 6F70              andi R22,15
 008A 7070              andi R23,0
 008C 6030              cpi R22,0
 008E 6707              cpc R22,R23
 0090 09F4              brne X47
 0092 13C2              xjmp L90
 0094           X47:
 0094           X3:
 0094 6230              cpi R22,2
 0096 E0E0              ldi R30,0
 0098 7E07              cpc R23,R30
 009A B9F0              breq L14
 009C           X4:
 009C 6030              cpi R22,0
 009E E0E0              ldi R30,0
 00A0 7E07              cpc R23,R30
 00A2 0CF4              brge X48
 00A4 16C2              xjmp L12
 00A6           X48:
 00A6           X5:
 00A6           L95:
 00A6 6830              cpi R22,8
 00A8 E0E0              ldi R30,0
 00AA 7E07              cpc R23,R30
 00AC 09F4              brne X49
 00AE BAC1              xjmp L82
 00B0           X49:
 00B0           X6:
 00B0 6930              cpi R22,9
 00B2 E0E0              ldi R30,0
 00B4 7E07              cpc R23,R30
 00B6 71F1              breq L19
 00B8           X7:
 00B8 6A30              cpi R22,10
 00BA E0E0              ldi R30,0
 00BC 7E07              cpc R23,R30
 00BE D1F0              breq L18
 00C0           X8:
 00C0 6C30              cpi R22,12
 00C2 E0E0              ldi R30,0
 00C4 7E07              cpc R23,R30
 00C6 99F1              breq L20
 00C8           X9:
 00C8 04C2              xjmp L12
 00CA           L14:
 00CA                   .dbline 72
 00CA           ;               {  // USB设备中断状态
 00CA           ;                       case USB_INT_EP2_OUT:  //USB端点2的OUT  USB_INT_EP2_OUT=0x02
 00CA           ;                        {  
 00CA                   .dbline 75
 00CA           ;                          // 批量端点下传成功 
 00CA           ;                               //if ( s & BIT_STAT_TOG_MATCH ) //0x10;
 00CA           ;                               {   RxData.flag=0;
 00CA                   .dbline 75
 00CA 2224              clr R2
 00CC 20920000          sts _RxData,R2
 00D0                   .dbline 76
 00D0           ;                                       RxData.len = Read374Byte( REG_USB_LENGTH );
 00D0 0BE0              ldi R16,11
 00D2 0E940000          xcall _Read374Byte
 00D6 A02E              mov R10,R16
 00D8 A0920100          sts _RxData+1,R10
 00DC                   .dbline 77
 00DC           ;                                       Read374Block( RAM_ENDP2_RECV,RxData.len,RxData.buf );
 00DC 80E0              ldi R24,<_RxData+2
 00DE 90E0              ldi R25,>_RxData+2
 00E0 9983              std y+1,R25
 00E2 8883              std y+0,R24
 00E4 2A2D              mov R18,R10
 00E6 00EC              ldi R16,192
 00E8 0E940000          xcall _Read374Block
 00EC                   .dbline 78
 00EC           ;                     RxData.flag=1;
 00EC 81E0              ldi R24,1
 00EE 80930000          sts _RxData,R24
 00F2                   .dbline 80
 00F2           ;                                       //printf("USB_INT_EP2_OUT len=%x\r\n",RxData.len);
 00F2           ;                       }
 00F2                   .dbline 81
 00F2           ;                               break;
 00F2 EFC1              xjmp L12
 00F4           L18:
 00F4                   .dbline 84
 00F4           ;                       }
 00F4           ;                       case USB_INT_EP2_IN:  //USB_INT_EP2_IN=0x0a, USB端点2的IN 
 00F4           ;                       {  // 批量端点上传成功,未处理
 00F4                   .dbline 85
 00F4           ;                               Write374Byte( REG_USB_ENDP2, M_SET_EP2_TRAN_NAK( Read374Byte( REG_USB_ENDP2 ) ) ^ BIT_EP2_TRAN_TOG );
 00F4 0EE0              ldi R16,14
 00F6 0E940000          xcall _Read374Byte
 00FA 602F              mov R22,R16
 00FC 80E4              ldi R24,64
 00FE 262F              mov R18,R22
 0100 2C7F              andi R18,252
 0102 2260              ori R18,2
 0104 2827              eor R18,R24
 0106 0EE0              ldi R16,14
 0108 0E940000          xcall _Write374Byte
 010C                   .dbline 86
 010C           ;                               EP2SendBusy=0;
 010C 2224              clr R2
 010E 20920000          sts _EP2SendBusy,R2
 0112                   .dbline 88
 0112           ;                               //printf("USB_INT_EP2_IN\r\n");
 0112           ;                               break;
 0112 DFC1              xjmp L12
 0114           L19:
 0114                   .dbline 91
 0114           ;                       }
 0114           ;                       case USB_INT_EP1_IN:   // 0x09,USB端点1的IN 
 0114           ;                       {  // 中断端点上传成功,未处理
 0114                   .dbline 92
 0114           ;                               Write374Byte( REG_USB_ENDP1, M_SET_EP1_TRAN_NAK( Read374Byte( REG_USB_ENDP1 ) ) ^ BIT_EP1_TRAN_TOG );
 0114 0DE0              ldi R16,13
 0116 0E940000          xcall _Read374Byte
 011A 602F              mov R22,R16
 011C 80E4              ldi R24,64
 011E 262F              mov R18,R22
 0120 207F              andi R18,240
 0122 2E60              ori R18,14
 0124 2827              eor R18,R24
 0126 0DE0              ldi R16,13
 0128 0E940000          xcall _Write374Byte
 012C                   .dbline 93
 012C           ;                               break;
 012C D2C1              xjmp L12
 012E           L20:
 012E                   .dbline 96
 012E           ;                       }
 012E           ;                       case USB_INT_EP0_SETUP:    //USB_INT_EP0_SETUP=0x0C     USB端点0的SETUP 
 012E           ;                       {  // 控制传输
 012E                   .dbline 99
 012E           ;                               USB_SETUP_REQ   SetupReqBuf;
 012E           ;                               
 012E           ;                               l = Read374Byte( REG_USB_LENGTH );
 012E 0BE0              ldi R16,11
 0130 0E940000          xcall _Read374Byte
 0134 A02E              mov R10,R16
 0136                   .dbline 100
 0136           ;                               if ( l == sizeof( USB_SETUP_REQ ) ) 
 0136 0830              cpi R16,8
 0138 09F0              breq X50
 013A 4EC1              xjmp L21
 013C           X50:
 013C           X10:
 013C                   .dbline 101
 013C           ;                               {
 013C                   .dbline 102
 013C           ;                                       Read374Block( RAM_ENDP0_RECV, l, (PUINT8)&SetupReqBuf );
 013C CE01              movw R24,R28
 013E 0296              adiw R24,2
 0140 9983              std y+1,R25
 0142 8883              std y+0,R24
 0144 2A2D              mov R18,R10
 0146 08E2              ldi R16,40
 0148 0E940000          xcall _Read374Block
 014C                   .dbline 103
 014C           ;                                       SetupLen = SetupReqBuf.wLengthL;
 014C 2884              ldd R2,y+8
 014E 20920100          sts L3,R2
 0152                   .dbline 104
 0152           ;                                       if ( SetupReqBuf.wLengthH || SetupLen > 0x7F ) SetupLen = 0x7F;  // 限制总长度
 0152 2984              ldd R2,y+9
 0154 2220              tst R2
 0156 29F4              brne L27
 0158           X11:
 0158 8FE7              ldi R24,127
 015A 20900100          lds R2,L3
 015E 8215              cp R24,R2
 0160 18F4              brsh L24
 0162           X12:
 0162           L27:
 0162                   .dbline 104
 0162 8FE7              ldi R24,127
 0164 80930100          sts L3,R24
 0168           L24:
 0168                   .dbline 105
 0168           ;                                       l = 0;  // 默认为成功并且上传0长度
 0168 AA24              clr R10
 016A                   .dbline 112
 016A           ;                                       
 016A           ;                                       /*if ( ( SetupReqBuf.bType & DEF_USB_REQ_TYPE ) != DEF_USB_REQ_STAND ) 
 016A           ;                                       {  // 只支持标准请求 
 016A           ;                                               l = 0xFF;  // 操作失败
 016A           ;                                       }
 016A           ;                                       else */
 016A           ;                                       {  // 标准请求
 016A                   .dbline 113
 016A           ;                                               SetupReq = SetupReqBuf.bReq;  // 请求码
 016A 2B80              ldd R2,y+3
 016C 20920000          sts L2,R2
 0170                   .dbline 116
 0170           ;                                               //printf("SetupReq:%x\r\n",SetupReq);
 0170           ;                                               
 0170           ;                                               switch( SetupReq ) 
 0170 622D              mov R22,R2
 0172 7727              clr R23
 0174 6030              cpi R22,0
 0176 6707              cpc R22,R23
 0178 09F4              brne X51
 017A 14C1              xjmp L73
 017C           X51:
 017C           X13:
 017C 6130              cpi R22,1
 017E E0E0              ldi R30,0
 0180 7E07              cpc R23,R30
 0182 09F4              brne X52
 0184 B8C0              xjmp L58
 0186           X52:
 0186           X14:
 0186 6530              cpi R22,5
 0188 E0E0              ldi R30,0
 018A 7E07              cpc R23,R30
 018C 09F4              brne X53
 018E 9EC0              xjmp L51
 0190           X53:
 0190           X15:
 0190 6630              cpi R22,6
 0192 E0E0              ldi R30,0
 0194 7E07              cpc R23,R30
 0196 D1F0              breq L32
 0198           X16:
 0198 6830              cpi R22,8
 019A E0E0              ldi R30,0
 019C 7E07              cpc R23,R30
 019E 09F4              brne X54
 01A0 99C0              xjmp L53
 01A2           X54:
 01A2           X17:
 01A2 6930              cpi R22,9
 01A4 E0E0              ldi R30,0
 01A6 7E07              cpc R23,R30
 01A8 09F4              brne X55
 01AA A1C0              xjmp L56
 01AC           X55:
 01AC           X18:
 01AC 6A30              cpi R22,10
 01AE E0E0              ldi R30,0
 01B0 7E07              cpc R23,R30
 01B2 09F4              brne X56
 01B4 ECC0              xjmp L70
 01B6           X56:
 01B6           X19:
 01B6 6030              cpi R22,0
 01B8 E0E0              ldi R30,0
 01BA 7E07              cpc R23,R30
 01BC 0CF4              brge X57
 01BE 09C1              xjmp L29
 01C0           X57:
 01C0           X20:
 01C0           L77:
 01C0 6E3F              cpi R22,254
 01C2 E0E0              ldi R30,0
 01C4 7E07              cpc R23,R30
 01C6 09F4              brne X58
 01C8 FFC0              xjmp L76
 01CA           X58:
 01CA           X21:
 01CA 03C1              xjmp L29
 01CC           L32:
 01CC                   .dbline 119
 01CC           ;                                               {   
 01CC           ;                                                       case DEF_USB_GET_DESCR:    //USB接收描述；DEF_USB_GET_DESCR=0x06
 01CC           ;                                                           switch( SetupReqBuf.wValueH ) 
 01CC 6D81              ldd R22,y+5
 01CE 7727              clr R23
 01D0 6130              cpi R22,1
 01D2 E0E0              ldi R30,0
 01D4 7E07              cpc R23,R30
 01D6 49F0              breq L37
 01D8           X22:
 01D8 6230              cpi R22,2
 01DA E0E0              ldi R30,0
 01DC 7E07              cpc R23,R30
 01DE 71F0              breq L38
 01E0           X23:
 01E0 6330              cpi R22,3
 01E2 E0E0              ldi R30,0
 01E4 7E07              cpc R23,R30
 01E6 99F0              breq L39
 01E8           X24:
 01E8 3EC0              xjmp L33
 01EA           L37:
 01EA                   .dbline 122
 01EA           ;                                                               {
 01EA           ;                                                                       case 1:
 01EA           ;                                                                               pDescr = (PUINT8)( &MyDevDescr[0] );
 01EA 80E0              ldi R24,<_MyDevDescr
 01EC 90E0              ldi R25,>_MyDevDescr
 01EE 90930300          sts L4+1,R25
 01F2 80930200          sts L4,R24
 01F6                   .dbline 123
 01F6           ;                                                                               l = sizeof( MyDevDescr );
 01F6 82E1              ldi R24,18
 01F8 A82E              mov R10,R24
 01FA                   .dbline 124
 01FA           ;                                                                               break;
 01FA 37C0              xjmp L34
 01FC           L38:
 01FC                   .dbline 126
 01FC           ;                                                                       case 2:
 01FC           ;                                                                               pDescr = (PUINT8)( &MyCfgDescr[0] );
 01FC 80E0              ldi R24,<_MyCfgDescr
 01FE 90E0              ldi R25,>_MyCfgDescr
 0200 90930300          sts L4+1,R25
 0204 80930200          sts L4,R24
 0208                   .dbline 127
 0208           ;                                                                               l = sizeof( MyCfgDescr );
 0208 87E2              ldi R24,39
 020A A82E              mov R10,R24
 020C                   .dbline 129
 020C           ;                                                                               //l = SetupReqBuf.wLengthL;
 020C           ;                                                                               break;
 020C 2EC0              xjmp L34
 020E           L39:
 020E                   .dbline 131
 020E           ;                                                                       case 3:
 020E           ;                                                                               switch( SetupReqBuf.wValueL ) 
 020E 6C81              ldd R22,y+4
 0210 7727              clr R23
 0212 6030              cpi R22,0
 0214 6707              cpc R22,R23
 0216 D9F0              breq L46
 0218           X25:
 0218 6130              cpi R22,1
 021A E0E0              ldi R30,0
 021C 7E07              cpc R23,R30
 021E 29F0              breq L44
 0220           X26:
 0220 6230              cpi R22,2
 0222 E0E0              ldi R30,0
 0224 7E07              cpc R23,R30
 0226 51F0              breq L45
 0228           X27:
 0228 1BC0              xjmp L40
 022A           L44:
 022A                   .dbline 134
 022A           ;                                                                               {
 022A           ;                                                                                       case 1:
 022A           ;                                                                                               pDescr = (PUINT8)( &MyManuInfo[0] );
 022A 80E0              ldi R24,<_MyManuInfo
 022C 90E0              ldi R25,>_MyManuInfo
 022E 90930300          sts L4+1,R25
 0232 80930200          sts L4,R24
 0236                   .dbline 135
 0236           ;                                                                                               l = sizeof( MyManuInfo );
 0236 8EE0              ldi R24,14
 0238 A82E              mov R10,R24
 023A                   .dbline 136
 023A           ;                                                                                               break;
 023A 17C0              xjmp L34
 023C           L45:
 023C                   .dbline 138
 023C           ;                                                                                       case 2:
 023C           ;                                                                                               pDescr = (PUINT8)( &MyProdInfo[0] );
 023C 80E0              ldi R24,<_MyProdInfo
 023E 90E0              ldi R25,>_MyProdInfo
 0240 90930300          sts L4+1,R25
 0244 80930200          sts L4,R24
 0248                   .dbline 139
 0248           ;                                                                                               l = sizeof( MyProdInfo );
 0248 82E1              ldi R24,18
 024A A82E              mov R10,R24
 024C                   .dbline 140
 024C           ;                                                                                               break;
 024C 0EC0              xjmp L34
 024E           L46:
 024E                   .dbline 142
 024E           ;                                                                                       case 0:
 024E           ;                                                                                               pDescr = (PUINT8)( &MyLangDescr[0] );
 024E 80E0              ldi R24,<_MyLangDescr
 0250 90E0              ldi R25,>_MyLangDescr
 0252 90930300          sts L4+1,R25
 0256 80930200          sts L4,R24
 025A                   .dbline 143
 025A           ;                                                                                               l = sizeof( MyLangDescr );
 025A 84E0              ldi R24,4
 025C A82E              mov R10,R24
 025E                   .dbline 144
 025E           ;                                                                                               break;
 025E 05C0              xjmp L34
 0260           L40:
 0260                   .dbline 146
 0260           ;                                                                                       default:
 0260           ;                                                                                               l = 0xFF;  // 操作失败
 0260 8FEF              ldi R24,255
 0262 A82E              mov R10,R24
 0264                   .dbline 147
 0264           ;                                                                                               break;
 0264                   .dbline 149
 0264           ;                                                                               }
 0264           ;                                                                               break;
 0264 02C0              xjmp L34
 0266           L33:
 0266                   .dbline 151
 0266           ;                                                                       default:
 0266           ;                                                                               l = 0xFF;  // 操作失败
 0266 8FEF              ldi R24,255
 0268 A82E              mov R10,R24
 026A                   .dbline 152
 026A           ;                                                                               break;
 026A           L34:
 026A                   .dbline 154
 026A           ;                                                               }
 026A           ;                                                               if ( SetupLen > l ) SetupLen = l;  // 限制总长度
 026A 2A2C              mov R2,R10
 026C 3324              clr R3
 026E 40900100          lds R4,L3
 0272 5524              clr R5
 0274 2414              cp R2,R4
 0276 3504              cpc R3,R5
 0278 14F4              brge L47
 027A           X28:
 027A                   .dbline 154
 027A A0920100          sts L3,R10
 027E           L47:
 027E                   .dbline 155
 027E           ;                                                               l = SetupLen >= RAM_ENDP0_SIZE ? RAM_ENDP0_SIZE : SetupLen;  // 本次传输长度
 027E 80910100          lds R24,L3
 0282 8830              cpi R24,8
 0284 18F0              brlo L49
 0286           X29:
 0286 68E0              ldi R22,8
 0288 70E0              ldi R23,0
 028A 03C0              xjmp L50
 028C           L49:
 028C 60910100          lds R22,L3
 0290 7727              clr R23
 0292           L50:
 0292 A62E              mov R10,R22
 0294                   .dbline 156
 0294           ;                                                               Write374Block2( RAM_ENDP0_TRAN, l, pDescr );  /* 加载上传数据 */
 0294 20900200          lds R2,L4
 0298 30900300          lds R3,L4+1
 029C 3982              std y+1,R3
 029E 2882              std y+0,R2
 02A0 2A2D              mov R18,R10
 02A2 00E2              ldi R16,32
 02A4 0E940000          xcall _Write374Block2
 02A8                   .dbline 157
 02A8           ;                                                               SetupLen -= l;
 02A8 20900100          lds R2,L3
 02AC 261A              sub R2,R22
 02AE 20920100          sts L3,R2
 02B2                   .dbline 158
 02B2           ;                                                               pDescr += l;
 02B2 20900200          lds R2,L4
 02B6 30900300          lds R3,L4+1
 02BA 4A2C              mov R4,R10
 02BC 5524              clr R5
 02BE 420C              add R4,R2
 02C0 531C              adc R5,R3
 02C2 50920300          sts L4+1,R5
 02C6 40920200          sts L4,R4
 02CA                   .dbline 159
 02CA           ;                                                               break;
 02CA 88C0              xjmp L22
 02CC           L51:
 02CC                   .dbline 161
 02CC           ;                                                       case DEF_USB_SET_ADDRESS:  //0x05
 02CC           ;                                                               SetupLen = SetupReqBuf.wValueL;  // 暂存USB设备地址
 02CC 2C80              ldd R2,y+4
 02CE 20920100          sts L3,R2
 02D2                   .dbline 162
 02D2           ;                                                               break;
 02D2 84C0              xjmp L22
 02D4           L53:
 02D4                   .dbline 164
 02D4           ;                                                       case DEF_USB_GET_CONFIG:   //0x08
 02D4           ;                                                               Write374Byte( RAM_ENDP0_TRAN, UsbConfig );
 02D4 20915E00          lds R18,_UsbConfig
 02D8 00E2              ldi R16,32
 02DA 0E940000          xcall _Write374Byte
 02DE                   .dbline 165
 02DE           ;                                                               if ( SetupLen >= 1 ) l = 1;
 02DE 80910100          lds R24,L3
 02E2 8130              cpi R24,1
 02E4 08F4              brsh X59
 02E6 7AC0              xjmp L22
 02E8           X59:
 02E8           X30:
 02E8                   .dbline 165
 02E8 AA24              clr R10
 02EA A394              inc R10
 02EC                   .dbline 166
 02EC           ;                                                               break;
 02EC 77C0              xjmp L22
 02EE           L56:
 02EE                   .dbline 168
 02EE           ;                                                       case DEF_USB_SET_CONFIG:  //0x09
 02EE           ;                                                               UsbConfig = SetupReqBuf.wValueL;
 02EE 2C80              ldd R2,y+4
 02F0 20925E00          sts _UsbConfig,R2
 02F4                   .dbline 169
 02F4           ;                                                               break;
 02F4 73C0              xjmp L22
 02F6           L58:
 02F6                   .dbline 171
 02F6           ;                                                       case DEF_USB_CLR_FEATURE:  //USB标准设备请求 0x01
 02F6           ;                                                               if ( ( SetupReqBuf.bType & 0x1F ) == 0x02 ) 
 02F6 8A81              ldd R24,y+2
 02F8 8F71              andi R24,31
 02FA 8230              cpi R24,2
 02FC 09F0              breq X60
 02FE 44C0              xjmp L59
 0300           X60:
 0300           X31:
 0300                   .dbline 172
 0300           ;                                                               {  // 不是端点不支持
 0300                   .dbline 173
 0300           ;                                                                       switch( SetupReqBuf.wIndexL ) 
 0300 6E81              ldd R22,y+6
 0302 7727              clr R23
 0304 6130              cpi R22,1
 0306 E0E0              ldi R30,0
 0308 7E07              cpc R23,R30
 030A 89F1              breq L68
 030C           X32:
 030C 6230              cpi R22,2
 030E E0E0              ldi R30,0
 0310 7E07              cpc R23,R30
 0312 C1F0              breq L66
 0314           X33:
 0314 6130              cpi R22,1
 0316 E0E0              ldi R30,0
 0318 7E07              cpc R23,R30
 031A 9CF1              brlt L61
 031C           X34:
 031C           L69:
 031C 6138              cpi R22,129
 031E E0E0              ldi R30,0
 0320 7E07              cpc R23,R30
 0322 D1F0              breq L67
 0324           X35:
 0324 6238              cpi R22,130
 0326 E0E0              ldi R30,0
 0328 7E07              cpc R23,R30
 032A 09F0              breq L65
 032C           X36:
 032C 2AC0              xjmp L61
 032E           L65:
 032E                   .dbline 176
 032E           ;                                                                       {
 032E           ;                                                                               case 0x82:
 032E           ;                                                                                       Write374Byte( REG_USB_ENDP2, M_SET_EP2_TRAN_NAK( Read374Byte( REG_USB_ENDP2 ) ) );
 032E 0EE0              ldi R16,14
 0330 0E940000          xcall _Read374Byte
 0334 602F              mov R22,R16
 0336 262F              mov R18,R22
 0338 2C7F              andi R18,252
 033A 2260              ori R18,2
 033C 0EE0              ldi R16,14
 033E 0E940000          xcall _Write374Byte
 0342                   .dbline 177
 0342           ;                                                                                       break;
 0342 4CC0              xjmp L22
 0344           L66:
 0344                   .dbline 179
 0344           ;                                                                               case 0x02:
 0344           ;                                                                                       Write374Byte( REG_USB_ENDP2, M_SET_EP2_RECV_ACK( Read374Byte( REG_USB_ENDP2 ) ) );
 0344 0EE0              ldi R16,14
 0346 0E940000          xcall _Read374Byte
 034A 602F              mov R22,R16
 034C 262F              mov R18,R22
 034E 2F7C              andi R18,207
 0350 0EE0              ldi R16,14
 0352 0E940000          xcall _Write374Byte
 0356                   .dbline 180
 0356           ;                                                                                       break;
 0356 42C0              xjmp L22
 0358           L67:
 0358                   .dbline 182
 0358           ;                                                                               case 0x81:
 0358           ;                                                                                       Write374Byte( REG_USB_ENDP1, M_SET_EP1_TRAN_NAK( Read374Byte( REG_USB_ENDP1 ) ) );
 0358 0DE0              ldi R16,13
 035A 0E940000          xcall _Read374Byte
 035E 602F              mov R22,R16
 0360 262F              mov R18,R22
 0362 207F              andi R18,240
 0364 2E60              ori R18,14
 0366 0DE0              ldi R16,13
 0368 0E940000          xcall _Write374Byte
 036C                   .dbline 183
 036C           ;                                                                                       break;
 036C 37C0              xjmp L22
 036E           L68:
 036E                   .dbline 185
 036E           ;                                                                               case 0x01:
 036E           ;                                                                                       Write374Byte( REG_USB_ENDP1, M_SET_EP1_RECV_ACK( Read374Byte( REG_USB_ENDP1 ) ) );
 036E 0DE0              ldi R16,13
 0370 0E940000          xcall _Read374Byte
 0374 602F              mov R22,R16
 0376 262F              mov R18,R22
 0378 2F7C              andi R18,207
 037A 0DE0              ldi R16,13
 037C 0E940000          xcall _Write374Byte
 0380                   .dbline 186
 0380           ;                                                                                       break;
 0380 2DC0              xjmp L22
 0382           L61:
 0382                   .dbline 188
 0382           ;                                                                               default:
 0382           ;                                                                                       l = 0xFF;  // 操作失败
 0382 8FEF              ldi R24,255
 0384 A82E              mov R10,R24
 0386                   .dbline 189
 0386           ;                                                                                       break;
 0386                   .dbline 191
 0386           ;                                                                       }
 0386           ;                                                               }
 0386 2AC0              xjmp L22
 0388           L59:
 0388                   .dbline 192
 0388           ;                                                               else l = 0xFF;  // 操作失败
 0388 8FEF              ldi R24,255
 038A A82E              mov R10,R24
 038C                   .dbline 193
 038C           ;                                                               break;
 038C 27C0              xjmp L22
 038E           L70:
 038E                   .dbline 195
 038E           ;                                                       case DEF_USB_GET_INTERF:
 038E           ;                                                               Write374Byte( RAM_ENDP0_TRAN, 0 );
 038E 2227              clr R18
 0390 00E2              ldi R16,32
 0392 0E940000          xcall _Write374Byte
 0396                   .dbline 196
 0396           ;                                                               if ( SetupLen >= 1 ) l = 1;
 0396 80910100          lds R24,L3
 039A 8130              cpi R24,1
 039C F8F0              brlo L22
 039E           X37:
 039E                   .dbline 196
 039E AA24              clr R10
 03A0 A394              inc R10
 03A2                   .dbline 197
 03A2           ;                                                               break;
 03A2 1CC0              xjmp L22
 03A4           L73:
 03A4                   .dbline 199
 03A4           ;                                                       case DEF_USB_GET_STATUS:
 03A4           ;                                                               Write374Byte( RAM_ENDP0_TRAN, 0 );
 03A4 2227              clr R18
 03A6 00E2              ldi R16,32
 03A8 0E940000          xcall _Write374Byte
 03AC                   .dbline 200
 03AC           ;                                                               Write374Byte( RAM_ENDP0_TRAN + 1, 0 );
 03AC 2227              clr R18
 03AE 01E2              ldi R16,33
 03B0 0E940000          xcall _Write374Byte
 03B4                   .dbline 201
 03B4           ;                                                               if ( SetupLen >= 2 ) l = 2;
 03B4 80910100          lds R24,L3
 03B8 8230              cpi R24,2
 03BA 18F0              brlo L74
 03BC           X38:
 03BC                   .dbline 201
 03BC 82E0              ldi R24,2
 03BE A82E              mov R10,R24
 03C0 0DC0              xjmp L22
 03C2           L74:
 03C2                   .dbline 202
 03C2           ;                                                               else l = SetupLen;
 03C2 A0900100          lds R10,L3
 03C6                   .dbline 203
 03C6           ;                                                               break;
 03C6 0AC0              xjmp L22
 03C8           L76:
 03C8                   .dbline 205
 03C8           ;                                                       case 0xfe:
 03C8           ;                                                               Write374Byte( RAM_ENDP0_TRAN, 0 );
 03C8 2227              clr R18
 03CA 00E2              ldi R16,32
 03CC 0E940000          xcall _Write374Byte
 03D0                   .dbline 209
 03D0           ;                                                               //Write374Byte( REG_USB_LENGTH, 1 );
 03D0           ;                                                  // Write374Byte( REG_USB_ENDP0, M_SET_EP0_TRAN_ACK( Read374Byte( REG_USB_ENDP0 ), l ) ^ BIT_EP0_TRAN_TOG );
 03D0           ;                                                               //printf("GET_MAX_LUN:\r\n");
 03D0           ;                                                               break;
 03D0 05C0              xjmp L22
 03D2           L29:
 03D2                   .dbline 211
 03D2           ;                                                       default:
 03D2           ;                                                               l = 0xFF;  // 操作失败
 03D2 8FEF              ldi R24,255
 03D4 A82E              mov R10,R24
 03D6                   .dbline 212
 03D6           ;                                                               break;
 03D6                   .dbline 214
 03D6           ;                                               }
 03D6           ;                                       }
 03D6                   .dbline 215
 03D6           ;                               }
 03D6 02C0              xjmp L22
 03D8           L21:
 03D8                   .dbline 216
 03D8           ;                               else l = 0xFF;  // 操作失败
 03D8 8FEF              ldi R24,255
 03DA A82E              mov R10,R24
 03DC           L22:
 03DC                   .dbline 217
 03DC           ;                               if ( l == 0xFF ) 
 03DC 8A2D              mov R24,R10
 03DE 8F3F              cpi R24,255
 03E0 29F4              brne L78
 03E2           X39:
 03E2                   .dbline 218
 03E2           ;                               {  // 操作失败
 03E2                   .dbline 219
 03E2           ;                                       Write374Byte( REG_USB_ENDP0, M_SET_EP0_RECV_STA( M_SET_EP0_TRAN_STA( 0 ) ) );  // STALL
 03E2 2FE3              ldi R18,63
 03E4 0CE0              ldi R16,12
 03E6 0E940000          xcall _Write374Byte
 03EA                   .dbline 220
 03EA           ;                               }
 03EA 73C0              xjmp L12
 03EC           L78:
 03EC                   .dbline 221
 03EC           ;                               else if ( l <= RAM_ENDP0_SIZE ) 
 03EC 88E0              ldi R24,8
 03EE 8A15              cp R24,R10
 03F0 70F0              brlo L80
 03F2           X40:
 03F2                   .dbline 222
 03F2           ;                               {  // 上传数据
 03F2                   .dbline 223
 03F2           ;                                       Write374Byte( REG_USB_ENDP0, M_SET_EP0_TRAN_ACK( M_SET_EP0_RECV_ACK( Read374Byte( REG_USB_ENDP0 ) ), l ) | BIT_EP0_TRAN_TOG );  // DATA1
 03F2 0CE0              ldi R16,12
 03F4 0E940000          xcall _Read374Byte
 03F8 602F              mov R22,R16
 03FA 8A2D              mov R24,R10
 03FC 8F70              andi R24,15
 03FE 262F              mov R18,R22
 0400 207C              andi R18,192
 0402 282B              or R18,R24
 0404 2064              ori R18,64
 0406 0CE0              ldi R16,12
 0408 0E940000          xcall _Write374Byte
 040C                   .dbline 224
 040C           ;                               }
 040C 62C0              xjmp L12
 040E           L80:
 040E                   .dbline 226
 040E           ;                               else 
 040E           ;                               {  // 下传数据或其它
 040E                   .dbline 227
 040E           ;                                       Write374Byte( REG_USB_ENDP0, M_SET_EP0_TRAN_NAK( M_SET_EP0_RECV_ACK( Read374Byte( REG_USB_ENDP0 ) ) ) | BIT_EP0_RECV_TOG );  // DATA1
 040E 0CE0              ldi R16,12
 0410 0E940000          xcall _Read374Byte
 0414 602F              mov R22,R16
 0416 262F              mov R18,R22
 0418 207C              andi R18,192
 041A 2E68              ori R18,142
 041C 0CE0              ldi R16,12
 041E 0E940000          xcall _Write374Byte
 0422                   .dbline 228
 0422           ;                               }
 0422                   .dbline 230
 0422           ;                               //ARD=2;
 0422           ;                               break;
 0422 57C0              xjmp L12
 0424           L82:
 0424                   .dbline 233
 0424           ;                       }
 0424           ;                       case USB_INT_EP0_IN:   // 0x08  USB端点0的IN
 0424           ;                       {
 0424                   .dbline 234
 0424           ;                               switch( SetupReq ) 
 0424 60910000          lds R22,L2
 0428 7727              clr R23
 042A 6530              cpi R22,5
 042C E0E0              ldi R30,0
 042E 7E07              cpc R23,R30
 0430 D1F1              breq L89
 0432           X41:
 0432 6630              cpi R22,6
 0434 E0E0              ldi R30,0
 0436 7E07              cpc R23,R30
 0438 09F0              breq L86
 043A           X42:
 043A 3AC0              xjmp L83
 043C           L86:
 043C                   .dbline 237
 043C           ;                               {
 043C           ;                                       case DEF_USB_GET_DESCR:
 043C           ;                                               l = SetupLen >= RAM_ENDP0_SIZE ? RAM_ENDP0_SIZE : SetupLen;  // 本次传输长度
 043C 80910100          lds R24,L3
 0440 8830              cpi R24,8
 0442 18F0              brlo L87
 0444           X43:
 0444 68E0              ldi R22,8
 0446 70E0              ldi R23,0
 0448 03C0              xjmp L88
 044A           L87:
 044A 60910100          lds R22,L3
 044E 7727              clr R23
 0450           L88:
 0450 A62E              mov R10,R22
 0452                   .dbline 238
 0452           ;                                               Write374Block2( RAM_ENDP0_TRAN, l, pDescr );  /* 加载上传数据 */
 0452 20900200          lds R2,L4
 0456 30900300          lds R3,L4+1
 045A 3982              std y+1,R3
 045C 2882              std y+0,R2
 045E 2A2D              mov R18,R10
 0460 00E2              ldi R16,32
 0462 0E940000          xcall _Write374Block2
 0466                   .dbline 239
 0466           ;                                               SetupLen -= l;
 0466 20900100          lds R2,L3
 046A 261A              sub R2,R22
 046C 20920100          sts L3,R2
 0470                   .dbline 240
 0470           ;                                               pDescr += l;
 0470 20900200          lds R2,L4
 0474 30900300          lds R3,L4+1
 0478 4A2C              mov R4,R10
 047A 5524              clr R5
 047C 420C              add R4,R2
 047E 531C              adc R5,R3
 0480 50920300          sts L4+1,R5
 0484 40920200          sts L4,R4
 0488                   .dbline 241
 0488           ;                                               Write374Byte( REG_USB_ENDP0, M_SET_EP0_TRAN_ACK( Read374Byte( REG_USB_ENDP0 ), l ) ^ BIT_EP0_TRAN_TOG );
 0488 0CE0              ldi R16,12
 048A 0E940000          xcall _Read374Byte
 048E 602F              mov R22,R16
 0490 8A2D              mov R24,R10
 0492 8F70              andi R24,15
 0494 262F              mov R18,R22
 0496 207F              andi R18,240
 0498 282B              or R18,R24
 049A 80E4              ldi R24,64
 049C 2827              eor R18,R24
 049E 0CE0              ldi R16,12
 04A0 0E940000          xcall _Write374Byte
 04A4                   .dbline 243
 04A4           ;                                               //printf("DEF_USB_GET_DESCR:\r\n");
 04A4           ;                                               break;
 04A4 16C0              xjmp L12
 04A6           L89:
 04A6                   .dbline 245
 04A6           ;                                       case DEF_USB_SET_ADDRESS:
 04A6           ;                                               Write374Byte( REG_USB_ADDR, SetupLen );
 04A6 20910100          lds R18,L3
 04AA 08E0              ldi R16,8
 04AC 0E940000          xcall _Write374Byte
 04B0           L83:
 04B0                   .dbline 247
 04B0           ;                                       default:
 04B0           ;                                               Write374Byte( REG_USB_ENDP0, M_SET_EP0_TRAN_NAK( 0 ) );  // 结束
 04B0 2EE0              ldi R18,14
 04B2 0CE0              ldi R16,12
 04B4 0E940000          xcall _Write374Byte
 04B8                   .dbline 248
 04B8           ;                                               break;
 04B8                   .dbline 250
 04B8           ;                               }
 04B8           ;                               break;
 04B8 0CC0              xjmp L12
 04BA           L90:
 04BA                   .dbline 253
 04BA           ;                       }
 04BA           ;                       case USB_INT_EP0_OUT:     //0x00， USB端点0的OUT 
 04BA           ;                       {
 04BA                   .dbline 254
 04BA           ;                               switch( SetupReq ) 
 04BA 60910000          lds R22,L2
 04BE 7727              clr R23
 04C0 6630              cpi R22,6
 04C2 E0E0              ldi R30,0
 04C4 7E07              cpc R23,R30
 04C6 09F0              breq L94
 04C8           X44:
 04C8 00C0              xjmp L91
 04CA           L94:
 04CA           L91:
 04CA                   .dbline 262
 04CA           ;                               {
 04CA           ; //                                    case download:
 04CA           ; //                                            get_data;
 04CA           ; //                                            break;
 04CA           ;                                       case DEF_USB_GET_DESCR:
 04CA           ;                                        //Write374Byte( RAM_ENDP0_TRAN,00 );
 04CA           ;                                       default:
 04CA           ;                                               Write374Byte( REG_USB_ENDP0, M_SET_EP0_TRAN_NAK( 0 ) );  // 结束
 04CA 2EE0              ldi R18,14
 04CC 0CE0              ldi R16,12
 04CE 0E940000          xcall _Write374Byte
 04D2                   .dbline 263
 04D2           ;                                               break;
 04D2                   .dbline 265
 04D2           ;                               }
 04D2           ;                               break;
 04D2                   .dbline 268
 04D2           ;                       }
 04D2           ;                       default: 
 04D2           ;                       {
 04D2                   .dbline 269
 04D2           ;                               break;
 04D2           L12:
 04D2                   .dbline 272
 04D2           ;                       }
 04D2           ;               }
 04D2           ;               Write374Byte( REG_INTER_FLAG, BIT_IF_USB_PAUSE | BIT_IF_TRANSFER );  // 清中断标志
 04D2 21E1              ldi R18,17
 04D4 09E0              ldi R16,9
 04D6 0E940000          xcall _Write374Byte
 04DA                   .dbline 273
 04DA           ;       }
 04DA 1BC0              xjmp L10
 04DC           L9:
 04DC                   .dbline 274
 04DC           ;       else if ( s & BIT_IF_USB_SUSPEND ) 
 04DC 42FF              sbrs R20,2
 04DE 0EC0              rjmp L96
 04E0           X45:
 04E0                   .dbline 275
 04E0           ;       {  // USB总线挂起
 04E0                   .dbline 276
 04E0           ;               Write374Byte( REG_INTER_FLAG, BIT_IF_USB_PAUSE | BIT_IF_USB_SUSPEND );  // 清中断标志
 04E0 24E1              ldi R18,20
 04E2 09E0              ldi R16,9
 04E4 0E940000          xcall _Write374Byte
 04E8                   .dbline 277
 04E8           ;               Write374Byte( REG_SYS_CTRL, Read374Byte( REG_SYS_CTRL ) | BIT_CTRL_OSCIL_OFF );  // 时钟振荡器停止振荡,进入睡眠状态
 04E8 05E0              ldi R16,5
 04EA 0E940000          xcall _Read374Byte
 04EE 602F              mov R22,R16
 04F0 262F              mov R18,R22
 04F2 2160              ori R18,1
 04F4 05E0              ldi R16,5
 04F6 0E940000          xcall _Write374Byte
 04FA                   .dbline 278
 04FA           ;       }
 04FA 0BC0              xjmp L97
 04FC           L96:
 04FC                   .dbline 279
 04FC           ;       else if ( s & BIT_IF_WAKE_UP ) 
 04FC 43FF              sbrs R20,3
 04FE 05C0              rjmp L98
 0500           X46:
 0500                   .dbline 280
 0500           ;       {  // 芯片唤醒完成
 0500                   .dbline 281
 0500           ;               Write374Byte( REG_INTER_FLAG, BIT_IF_USB_PAUSE | BIT_IF_WAKE_UP );  // 清中断标志
 0500 28E1              ldi R18,24
 0502 09E0              ldi R16,9
 0504 0E940000          xcall _Write374Byte
 0508                   .dbline 282
 0508           ;       }
 0508 04C0              xjmp L99
 050A           L98:
 050A                   .dbline 284
 050A           ;       else 
 050A           ;       {  // 意外的中断,不可能发生的情况,除了硬件损坏
 050A                   .dbline 285
 050A           ;               Write374Byte( REG_INTER_FLAG, BIT_IF_USB_PAUSE | BIT_IF_INTER_FLAG );  // 清中断标志
 050A 2FE1              ldi R18,31
 050C 09E0              ldi R16,9
 050E 0E940000          xcall _Write374Byte
 0512                   .dbline 286
 0512           ;       }
 0512           L99:
 0512           L97:
 0512           L10:
 0512           L8:
 0512                   .dbline -2
 0512           L1:
 0512                   .dbline 0 ; func end
 0512 2A96              adiw R28,10
 0514 0E940000          xcall pop_xgsetF00C
 0518 0990              ld R0,y+
 051A 0FBE              OUT 63,R0
 051C F991              ld R31,y+
 051E E991              ld R30,y+
 0520 B991              ld R27,y+
 0522 A991              ld R26,y+
 0524 9991              ld R25,y+
 0526 8991              ld R24,y+
 0528 3991              ld R19,y+
 052A 2991              ld R18,y+
 052C 1991              ld R17,y+
 052E 0991              ld R16,y+
 0530 9990              ld R9,y+
 0532 8990              ld R8,y+
 0534 7990              ld R7,y+
 0536 6990              ld R6,y+
 0538 5990              ld R5,y+
 053A 4990              ld R4,y+
 053C 3990              ld R3,y+
 053E 2990              ld R2,y+
 0540 1990              ld R1,y+
 0542 0990              ld R0,y+
 0544 1895              reti
 0546                   .dbsym l SetupReqBuf 2 S[_USB_SETUP_REQ]
 0546                   .dbsym l i 3 c
 0546                   .dbsym l k 3 i
 0546                   .dbsym r l 10 c
 0546                   .dbsym r m 10 c
 0546                   .dbsym r s 20 c
 0546                   .dbend
 0546                   .dbfunc e Init374Device _Init374Device fV
                        .even
 0546           _Init374Device::
 0546                   .dbline -1
 0546                   .dbline 291
 0546           ;       
 0546           ; }
 0546           ; 
 0546           ; void  Init374Device( void )  // 初始化USB设备
 0546           ; {     
 0546                   .dbline 292
 0546           ;       Write374Byte( REG_USB_ADDR, 0x00 );
 0546 2227              clr R18
 0548 08E0              ldi R16,8
 054A 0E940000          xcall _Write374Byte
 054E                   .dbline 293
 054E           ;       Write374Byte( REG_USB_ENDP0, M_SET_EP0_TRAN_NAK( 0 ) );
 054E 2EE0              ldi R18,14
 0550 0CE0              ldi R16,12
 0552 0E940000          xcall _Write374Byte
 0556                   .dbline 294
 0556           ;       Write374Byte( REG_USB_ENDP1, M_SET_EP1_TRAN_NAK( 0 ) );
 0556 2EE0              ldi R18,14
 0558 0DE0              ldi R16,13
 055A 0E940000          xcall _Write374Byte
 055E                   .dbline 295
 055E           ;       Write374Byte( REG_USB_ENDP2, M_SET_EP2_TRAN_NAK( 0 ) );
 055E 22E0              ldi R18,2
 0560 0EE0              ldi R16,14
 0562 0E940000          xcall _Write374Byte
 0566                   .dbline 296
 0566           ;       Write374Byte( REG_INTER_FLAG, BIT_IF_USB_PAUSE | BIT_IF_INTER_FLAG );  // 清所有中断标志
 0566 2FE1              ldi R18,31
 0568 09E0              ldi R16,9
 056A 0E940000          xcall _Write374Byte
 056E                   .dbline 297
 056E           ;       Write374Byte( REG_INTER_EN, BIT_IE_TRANSFER | BIT_IE_BUS_RESET | BIT_IE_USB_SUSPEND );  // 允许传输完成中断和USB总线复位中断以及USB总线挂起中断,芯片唤醒完成中断
 056E 27E0              ldi R18,7
 0570 07E0              ldi R16,7
 0572 0E940000          xcall _Write374Byte
 0576                   .dbline 298
 0576           ;       Write374Byte( REG_SYS_CTRL, BIT_CTRL_OE_POLAR );  // 对于CH374T或者UEN引脚悬空的CH374S必须置BIT_CTRL_OE_POLAR为1
 0576 20E4              ldi R18,64
 0578 05E0              ldi R16,5
 057A 0E940000          xcall _Write374Byte
 057E                   .dbline 299
 057E           ;       Write374Byte( REG_USB_SETUP, BIT_SETP_TRANS_EN | BIT_SETP_PULLUP_EN );  // 启动USB设备
 057E 23E0              ldi R18,3
 0580 06E0              ldi R16,6
 0582                   .dbline -2
 0582           L100:
 0582                   .dbline 0 ; func end
 0582 0C940000          xjmp _Write374Byte
 0586                   .dbend
 0586                   .dbfunc e USBStart _USBStart fV
 0586           ;              i -> R20,R21
                        .even
 0586           _USBStart::
 0586 4A93              st -y,R20
 0588 5A93              st -y,R21
 058A                   .dbline -1
 058A                   .dbline 304
 058A           ; }
 058A           ; 
 058A           ; 
 058A           ; void USBStart(void)
 058A           ; {
 058A                   .dbline 308
 058A           ;       unsigned int i;
 058A           ;  
 058A           ;  
 058A           ;         Write374Byte(REG_SYS_CTRL,0x08);         //CH374软复位
 058A 28E0              ldi R18,8
 058C 05E0              ldi R16,5
 058E 0E940000          xcall _Write374Byte
 0592                   .dbline 309
 0592           ;         for(i=0;i<50000;i++);//18ms
 0592 4427              clr R20
 0594 5527              clr R21
 0596 02C0              xjmp L105
 0598           L102:
 0598                   .dbline 309
 0598           L103:
 0598                   .dbline 309
 0598 4F5F              subi R20,255  ; offset = 1
 059A 5F4F              sbci R21,255
 059C           L105:
 059C                   .dbline 309
 059C 80E5              ldi R24,80
 059E 93EC              ldi R25,195
 05A0 A0E0              ldi R26,0
 05A2 B0E0              ldi R27,0
 05A4 1A01              movw R2,R20
 05A6 4424              clr R4
 05A8 5524              clr R5
 05AA 2816              cp R2,R24
 05AC 3906              cpc R3,R25
 05AE 4A06              cpc R4,R26
 05B0 5B06              cpc R5,R27
 05B2 94F3              brlt L102
 05B4           X61:
 05B4                   .dbline 310
 05B4           ;         Write374Byte(REG_SYS_CTRL,0x00);
 05B4 2227              clr R18
 05B6 05E0              ldi R16,5
 05B8 0E940000          xcall _Write374Byte
 05BC                   .dbline 311
 05BC           ;         for(i=0;i<50000;i++);//18ms 
 05BC 4427              clr R20
 05BE 5527              clr R21
 05C0 02C0              xjmp L109
 05C2           L106:
 05C2                   .dbline 311
 05C2           L107:
 05C2                   .dbline 311
 05C2 4F5F              subi R20,255  ; offset = 1
 05C4 5F4F              sbci R21,255
 05C6           L109:
 05C6                   .dbline 311
 05C6 80E5              ldi R24,80
 05C8 93EC              ldi R25,195
 05CA A0E0              ldi R26,0
 05CC B0E0              ldi R27,0
 05CE 1A01              movw R2,R20
 05D0 4424              clr R4
 05D2 5524              clr R5
 05D4 2816              cp R2,R24
 05D6 3906              cpc R3,R25
 05D8 4A06              cpc R4,R26
 05DA 5B06              cpc R5,R27
 05DC 94F3              brlt L106
 05DE           X62:
 05DE                   .dbline 314
 05DE           ;  
 05DE           ;        
 05DE           ;        Init374Device();
 05DE B3DF              xcall _Init374Device
 05E0                   .dbline -2
 05E0           L101:
 05E0                   .dbline 0 ; func end
 05E0 5991              ld R21,y+
 05E2 4991              ld R20,y+
 05E4 0895              ret
 05E6                   .dbsym r i 20 i
 05E6                   .dbend
 05E6           ;       // while(UsbConfig == 0); //等待USB驱动安装成功 
 05E6           ; }
